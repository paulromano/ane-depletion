\documentclass[3p,authoryear]{elsarticle}
\journal{Annals of Nuclear Energy}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[charter]{mathdesign} % Type-1 Latin Modern modern
\usepackage[T1]{fontenc}         % Use T1 encoding instead of OT1
\usepackage[utf8]{inputenc}      % Use UTF8 input encoding
\usepackage{microtype}           % Improve typography
\usepackage{booktabs}            % Publication quality tables
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{float}
\usepackage{algorithm}
\usepackage{algorithmicx}
\usepackage{algpseudocode}
\usepackage{siunitx}
\usepackage{multirow}

\sisetup{list-final-separator = {, and }}

% Captions for figures and tables
\usepackage[labelfont=bf]{caption}
\captionsetup[figure]{labelsep=period, name=Fig.}
\captionsetup[table]{labelsep=newline}

\usepackage{color}
\definecolor{aneblue}{RGB}{0,128,173}
\usepackage[colorlinks,breaklinks,bookmarksnumbered,bookmarksopen]{hyperref}
\AtBeginDocument{
  \hypersetup{linkcolor=aneblue, citecolor=aneblue, urlcolor=aneblue}
}

\usepackage[capitalise,nameinlink]{cleveref}

\newtheorem{lemma}{Lemma}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\title{Depletion capabilities in the OpenMC Monte Carlo particle transport code}

\author[anl]{Paul K. Romano\corref{cor1}}
\ead{promano@anl.gov}
\cortext[cor1]{Corresponding author. Tel.: +1 630 252 6779.}

\author[lanl]{Colin Josey}
\ead{cjosey@lanl.gov}

\author[gatech]{Andrew E. Johnson}
\ead{dasindrew@gatech.edu}

\author[tsinghua]{Jingang Liang}
\ead{jingang@tsinghua.edu.cn}

\address[anl]{Argonne National Laboratory, 9700 S. Cass Ave, Lemont, IL 60439, United States}
\address[lanl]{Los Alamos National Laboratory, PO Box 1663, Los Alamos, NM 87545, United States}
\address[gatech]{Georgia Institute of Technology, 770 State St NW, Atlanta, GA 30318, United States}
\address[tsinghua]{Institute of Nuclear and New Energy Technology, Tsinghua University, Beijing, China}

\begin{abstract}

\end{abstract}

\begin{keyword}
  Monte Carlo, depletion
\end{keyword}

\maketitle

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}

When a material in a system is subject to irradiation over a long period of
time, nuclides within the material will transmute due to nuclear reactions and
spontaneous radioactive decay. The time-dependent process by which nuclides
transmute under irradiation is known as \emph{depletion}, \emph{burnup}, or
\emph{transmutation}. Modeling this process plays an important role in the
design and licensing of nuclear reactors~\citep{betzler2019ned}. Consequently,
many codes have been developed that solve the underlying equations for the
change in material compositions over time.

When modeling nuclear reactors, depletion is inherently linked with solving the
neutron transport equation. Nuclear reaction rates, which determine the rate at
which nuclides are transmuted, must be provided from a transport code.
Conversely, the change in material composition directly affects the solution of
the transport equation. As will be shown in \cref{sec:methods}, this results in
a non-linear coupling between transport and depletion. The implication is that
depletion codes are rarely used in isolation---normally, they are directly
coupled with a neutron transport code.

With continued advances in computing, Monte Carlo (MC) particle transport
simulations are now widely used in reactor design and analysis in a variety of
roles. The earliest efforts to couple MC particle transport with depletion date
back to the 1990s~\citep{moore1995inel,trellue1998lanl}. These early efforts
involved taking existing MC and depletion codes, such as
MCNP~\citep{goorley2012nt} and ORIGEN~\citep{croff1983nt}, and putting a
``wrapper'' around them that orchestrated the transfer of solutions from one
code to the other. Thus, the actual transport/depletion codes themselves
required no source code changes. In the last decade, many MC code developers
have chosen to directly include a depletion solver as a first-rate feature,
including MCNPX~\citep{waters2007aip} (which has since been merged into
MCNP6~\citep{goorley2012nt}), Serpent~\citep{leppanen2015ane}, and
MC21~\citep{griesheimer2015ane}.

In the present work, we describe a new depletion solver in
OpenMC~\citep{romano2015ane1}, an open source, community-developed MC particle
transport code. To date, OpenMC has not had a built-in depletion solver. This
has led to numerous efforts in the community toward developing coupled
transport-depletion calculations with
OpenMC~\citep{gul2017ane,lanversin2017icone,lanversin2019phd,liu2019nst,zhuang2020pne,zhao2020ned,zhao2020cpc,zhang2020ane}.
While these efforts have proven the viability of performing such coupled
calculations with OpenMC, none of them has resulted in a validated,
openly-available, and generalized capability that OpenMC users can take
advantage of. The capability that is described herein is part of the OpenMC
project and can be found in version 0.11 of the code or later.

The paper is organized as follows. In \cref{sec:methods}, we describe the
methods and algorithms used to solve the depletion equations, the implementation
within OpenMC, and how nuclear data is used to create depletion chains. Then, in
\cref{sec:results}, we present results on two problems that demonstrate the
accuracy of OpenMC when compared to Serpent~\citep{leppanen2015ane}. In
\cref{sec:conclusions}, we summarize the findings, discuss limitations, and
provide commentary on future avenues of inquiry that may be promising.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Methodology}
\label{sec:methods}

The equation that governs the transmutation and decay of nuclides inside of an
irradiated environment can be written as
\begin{equation}
  \frac{dN_i(t)}{dt} = \sum\limits_j
  \underbrace{\left [ \underbrace{f_{j \rightarrow i} \int_0^\infty dE \;
  \sigma_j (E, t) \phi(E,t)}_\text{transmutation} +
  \underbrace{\lambda_{j\rightarrow i}}_\text{decay} \right ]
  N_j(t)}_{\text{Production of nuclide }i\text{ from nuclide }j}
  - \underbrace{\left [\underbrace{\int_0^\infty dE \; \sigma_i
  (E,t) \phi(E,t)}_\text{transmutation} +
  \underbrace{\sum\limits_j \lambda_{i\rightarrow j}}_\text{decay} \right ]
  N_i(t)}_{\text{Loss of nuclide }i}
\end{equation}
where $N_i$ is the density of nuclide $i$ at time $t$, $\sigma_i$ is the
transmutation cross section for nuclide $i$ at energy $E$ and time $t$, $\phi$
is the neutron flux at energy $E$ and time $t$, $f_{j \rightarrow i}$ is the
fraction of transmutation reactions in nuclide $j$ that produce nuclide $i$, and
$\lambda_{j \rightarrow i}$ is the decay constant for decay modes in nuclide $j$
that produce nuclide $i$. Note that we have not included the spatial dependence
of the flux or cross sections. As one can see, the equation simply states that
the rate of change of $N_i$ is equal to the production rate minus the loss rate.
Because the equation for nuclide $i$ depends on the nuclide density for possibly
many other nuclides, we have a system of first-order differential equations. To
form a proper initial value problem, we also need the nuclide densities at time
0:
\begin{equation}
    N_i(0) = N_{i,0}.
\end{equation}
These equations can be written more compactly in matrix notation as
\begin{equation}
  \label{eq:depletion-matrix}
  \frac{d\mathbf{n}}{dt} = \mathbf{A}(\mathbf{n},t)\mathbf{n}, \quad \mathbf{n}(0) =
  \mathbf{n}_0
\end{equation}
where $\mathbf{n} \in \mathbb{R}^n$ is the nuclide density vector,
$\mathbf{A}(\mathbf{n},t) \in \mathbb{R}^{n\times n}$ is the burnup matrix
containing the decay and transmutation coefficients, and $\mathbf{n}_0$ is the
initial density vector. Note that the burnup matrix depends on $\mathbf{n}$
because the solution to the transport equation depends on the nuclide densities.

\subsection{Time integration}
\label{sec:time_integration}

Mention Isotalo papers

A variety of numerical methods exist for solving \cref{eq:depletion-matrix}. The
simplest such method, known as the "predictor" method, is to divide the overall
time interval of interest $[0,t]$ into smaller timesteps over which it is
assumed that the burnup matrix is constant. Let $t \in [t_i, t_i + h]$ be one
such timestep. Over the timestep, the solution to \cref{eq:depletion-matrix} can
be written analytically using the matrix exponential
\begin{equation}
    \mathbf{A}_i = \mathbf{A}(\mathbf{n}_i, t_i) \\
    \mathbf{n}_{i+1} = e^{\mathbf{A}_i h} \mathbf{n}_i
\end{equation}
where $\mathbf{n}_i \equiv \mathbf{n}(t_i)$. The exponential of a matrix
$\mathbf{X}$ is defined by the power series expansion
\begin{equation}
    e^{\mathbf{X}} = \sum\limits_{k=0}^\infty \frac{1}{k!} \left ( \mathbf{X}
    \right )^k
\end{equation}
where $\mathbf{X}^0 = \mathbf{I}$. A series of so-called predictor-corrector
methods that use multiple stages offer improved accuracy over the predictor
method. The simplest of these methods, the CE/CM algorithm, is defined as
\begin{equation}
    \mathbf{n}_{i+1/2} = e^{\frac{h}{2}\mathbf{A}(\mathbf{n}_i, t_i)} \mathbf{n}_i \\
    \mathbf{n}_{i+1} = e^{h \mathbf{A}(\mathbf{n}_{i+1/2},t_{i+1/2})} \mathbf{n}_i
\end{equation}
Here, the value of $\mathbf{n}$ at the midpoint is estimated using
$\mathbf{A}$ evaluated at the beginning of the timestep. Then,
$\mathbf{A}$ is evaluated using the densities at the midpoint and used to
integrate over the entire timestep.

Our aim here is not to exhaustively describe all integration methods but rather
to give a few examples that elucidate the main considerations one must take into
account when choosing a method. Generally, there is a tradeoff between the
accuracy of the method and its computational expense. The expense is driven
almost entirely by the time to compute a transport solution, i.e., to evaluate
$\mathbf{A}$ for a given $\mathbf{n}$. Thus, the cost of a method scales with
the number of $\mathbf{A}$ evaluations that are performed per timestep. On the
other hand, methods that require more evaluations generally achieve higher
accuracy. The predictor method only requires one evaluation and its error
converges as $\mathcal{O}(h)$. The CE/CM method requires two evaluations and is
thus twice as expensive as the predictor method, but achieves an error of
$\mathcal{O}(h^2)$. An exhaustive description of time integration methods and
their merits can be found in the thesis of \citet{josey2017phd}.

OpenMC does not rely on a single time integration method but rather has several
classes that implement different algorithms. For example, the
openmc.deplete.PredictorIntegrator class implements the predictor
method, and the openmc.deplete.CECMIntegrator class implements the
CE/CM method. A full list of the integrator classes available can be found in
the documentation for the openmc.deplete module.

\subsection{Matrix Exponential}

As we saw in \cref{sec:time_integration}, numerically integrating
\cref{eq:depletion-matrix} requires evaluating one or more matrix exponentials.
OpenMC uses the Chebyshev rational approximation method (CRAM), which was
introduced in a series of papers by Pusa~\citep{pusa2010nse,pusa2011nse}, to
evaluate matrix exponentials. In particular, OpenMC utilizes an incomplete
partial fraction (IPF) form~\citep{pusa2016nse} of CRAM that provides a good
balance of numerical stability and efficiency. In this representation the matrix
exponential is approximated as
\begin{equation}
    e^{\mathbf{A}t} \approx \alpha_0 \prod\limits_{\ell=1}^{k/2} \left (
    \mathbf{I} + 2 \text{Re} \left ( \widetilde{\alpha}_\ell \left (\mathbf{A}t
    - \theta_\ell \mathbf{I} \right )^{-1} \right ) \right )
\end{equation}
where $k$ is the order of the approximation and $\alpha_0$,
$\widetilde{\alpha}_\ell$, and $\theta_\ell$ are coefficients that have been
tabulated for orders up to $k=48$. Rather than computing the full approximation
and then multiplying it by a vector, the following algorithm\footnote{The
original description of the algorithm presented by \citet{pusa2016nse} contains
a typo.} is used to incrementally apply the terms within the product:
\begin{algorithm}[H]
  \caption{Incomplete partial fraction form of CRAM.}
  \label{alg:cram}
  \begin{algorithmic}[1]
    \State $\mathbf{n} \gets \mathbf{n_0}$
    \For{$\ell \gets 1$ \textbf{to} $k/2$}
      \State $\mathbf{n} \gets \mathbf{n} + 2\text{Re}(\widetilde{\alpha}_\ell
        (\mathbf{A}t - \theta_\ell)^{-1})\mathbf{n}$
    \EndFor
    \State $\mathbf{n} \gets \alpha_0 \mathbf{n}$
  \end{algorithmic}
\end{algorithm}
The $k$\ th order approximation for CRAM requires solving $k/2$ sparse linear
systems. OpenMC relies on functionality from scipy.sparse.linalg for solving the
linear systems.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Results}
\label{sec:results}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Conclusions}
\label{sec:conclusions}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section*{Acknowledgments}

This research was supported by the Exascale Computing Project (17-SC-20-SC), a
collaborative effort of the U.S. Department of Energy Office of Science and the
National Nuclear Security Administration. The submitted manuscript has been
created by UChicago Argonne, LLC, operator of Argonne National Laboratory under
contract DE-AC02-06CH11357.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section*{References}

\bibliographystyle{elsarticle-harv}
\bibliography{references}

\clearpage
\vspace*{\fill}
\noindent\fbox{%
  \parbox{\textwidth}{%
    The submitted manuscript has been created by UChicago Argonne, LLC, Operator
    of Argonne \mbox{National} Laboratory (``Argonne'').  Argonne, a
    U.S. Department of Energy Office of Science laboratory, is operated
    under Contract No. \mbox{DE-AC02-06CH11357}.  The U.S. Government retains for
    itself, and others acting on its behalf, a paid-up nonexclusive, irrevocable
    worldwide license in said article to reproduce, prepare derivative works,
    distribute copies to the public, and perform publicly and display publicly,
    by or on behalf of the Government. The Department of Energy will provide
    public access to these results of federally sponsored research in accordance
    with the DOE Public Access
    Plan. \url{http://energy.gov/downloads/doe-public-access-plan.}
  }%
}
\vspace*{\fill}

\end{document}
